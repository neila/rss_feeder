name: RSS feed
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write
  
jobs:
  pull:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - category: world_news
            thread_id: "1223241787645235240"
            feeds: '["http://feeds.bbci.co.uk/news/world/rss.xml","https://www.nytimes.com/svc/collections/v1/publish/https://www.nytimes.com/section/world/rss.xml","http://www.aljazeera.com/xml/rss/all.xml","https://www.reutersagency.com/feed/?taxonomy=best-regions&post_type=best","https://www.e-ir.info/feed/"]'
          - category: jp_news
            thread_id: "1223262951486656583"
            feeds: '["https://www.japantimes.co.jp/feed/","https://www3.nhk.or.jp/rss/news/cat0.xml","https://english.kyodonews.net/rss/all.xml","https://richardkatz.substack.com/feed"]'
          - category: blogs
            thread_id: ""
            feeds: '["https://thethirdwave.co/blog/feed/","https://www.lesswrong.com/feed.xml?view=curated-rss","https://annasofia.xyz/feed","https://xn--gckvb8fzb.com/index.xml","https://gwern.substack.com/feed","https://www.zephoria.org/thoughts/feed","https://gunther.link/index.xml","https://dooce.com/feed/","https://www.ribbonfarm.com/feed/","https://www.shenmacro.com/atom.xml"]'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -q feedparser requests
      - name: fetch + post
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
          CATEGORY: ${{ matrix.category }}
          THREAD_ID: ${{ matrix.thread_id }}
          FEED_URLS: ${{ matrix.feeds }}
        run: python scripts/rss2feed.py
      - uses: actions/upload-artifact@v4
        with:
          name: rss-state-${{ matrix.category }}
          path: cache/updates_${{ matrix.category }}.json

  push:
    needs: pull
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          pattern: rss-state-*
          path: cache
          merge-multiple: true

      - name: commit state if changed
        run: |
          git config user.name "[cron] RSS pull"
          git config user.email "40727091+neila@users.noreply.github.com"
          git add cache/updates*.json
          if ! git diff --cached --quiet; then
            git commit -m "$(date -u +"%Y-%m-%d") pull RSS feed"
            git push
          fi
